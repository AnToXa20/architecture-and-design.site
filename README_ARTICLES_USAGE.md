# Инструкция по работе с системой статей

## Последние исправления (v2.4)

### ✅ Исправлена проблема отображения через localhost:3001
- **Настроена корректная подача статических файлов** из корневой директории
- **Исправлены пути к CSS, JS, изображениям** для работы через веб-сервер
- **Теперь главная страница полностью функциональна** на http://localhost:3001/
- **Стили, навигация и слайдер работают корректно** через localhost
- **Убрана зависимость от file:// протокола** для корректного функционирования

### ✅ Исправлена проблема с URL главного изображения статьи
- **Унифицированная обработка URL** для главного изображения и блоков контента
- **Двойная проверка альтернативных методов** в catch блоке
- **Улучшенное логирование** для четкого понимания какое изображение обрабатывается
- **Идентичная логика** получения ссылок для всех типов изображений
- **Более надежное fallback** на альтернативные методы при ошибках API

### ✅ Исправлена проблема с нерабочими URL-ссылками изображений
- **Многоуровневая система получения прямых ссылок** с 4 различными методами
- **Автоматическая проверка валидности URL** перед сохранением в БД
- **Fallback механизм** - если один метод не работает, пробуется следующий
- **Детальное логирование** процесса получения ссылок для отладки
- **Таймауты и обработка ошибок** для предотвращения зависания

### ✅ Упрощены уведомления в админ-панели
- Убраны смайлики и лишний текст из уведомлений
- Более краткие и информативные сообщения
- Улучшена читаемость уведомлений

### ✅ Полная интеграция загрузки изображений в админ-панель
- **Админ-панель теперь поддерживает изображения блоков** как в тестовой странице
- Добавлена правильная отправка файлов изображений блоков (`blockImage_0`, `blockImage_1`, etc.)
- Реализовано сохранение файлов в блоках для корректной обработки
- Добавлена кнопка удаления изображений из блоков
- Улучшены уведомления с детальной информацией о процессе создания

### ✅ Исправлена загрузка изображений в блоках контента
- Изображения из блоков теперь корректно загружаются на Яндекс.Диск
- Добавлена обработка до 10 изображений в блоках (blockImage_0 до blockImage_9)
- Улучшена логика привязки файлов к блокам через imageIndex

### ✅ Исправлены URL-ссылки на изображения
- Реализована функция `getActualDownloadUrl()` для получения рабочих прямых ссылок
- URL теперь возвращают прямые ссылки на скачивание вместо ошибки 403
- Добавлена обработка ошибок с fallback на публичные ссылки

### ✅ Улучшены имена файлов
- Функция `createSafeFileName()` создает безопасные имена без странных символов
- Добавлена транслитерация кириллицы в латиницу
- Префиксы для разных типов изображений (main-, block0-, block1- и т.д.)

## Тестовые страницы

### 1. Простая тестовая страница
**URL:** `http://localhost:3001/test_simple_article.html`
- Базовая функциональность создания статей
- Только главное изображение и простые поля

### 2. Продвинутая тестовая страница  
**URL:** `http://localhost:3001/test_advanced_article.html`
- Полная функциональность с блоками контента
- Динамическое добавление текстовых и изображений блоков
- Удаление блоков

### 3. Тест загрузки изображений блоков (НОВАЯ)
**URL:** `http://localhost:3001/test_image_blocks.html`
- Специально для тестирования загрузки изображений в блоки
- Фиксированная структура: текст → изображение → текст → изображение
- Простой интерфейс для проверки корректности работы

### 4. Полная админ-панель
**URL:** `http://localhost:3001/admin`
- Производственная версия с полным функционалом

## Структура базы данных

### Таблица `articles`
- `id` - автоинкремент ID
- `title` - название статьи
- `slug` - URL-slug (автоматически из title)
- `category` - категория
- `short_description` - краткое описание
- `main_image_url` - **прямая ссылка** на главное изображение
- `status` - статус (draft/published)
- `publication_date` - дата публикации

### Таблица `content_blocks`
- `id` - автоинкремент ID
- `entity_type` - 'article'
- `entity_id` - ID статьи
- `block_type` - 'text' или 'image'
- `content` - текст блока или подпись к изображению
- `image_url` - **прямая ссылка** на изображение блока
- `caption` - подпись к изображению
- `sort_order` - порядок сортировки

### Таблица `article_architects`
- `article_id` - ID статьи
- `architect_id` - ID автора
- `is_main_author` - основной автор (1/0)

## API Endpoints

### POST `/api/db/articles`
Создание новой статьи с блоками контента

**FormData поля:**
- `title` - название статьи (обязательно)
- `category` - категория (обязательно)
- `authorId` - ID автора
- `shortDescription` - краткое описание
- `mainImage` - файл главного изображения
- `contentBlocks` - JSON-строка с данными блоков
- `blockImage_0`, `blockImage_1`, ... `blockImage_9` - файлы изображений блоков

**Формат contentBlocks:**
```json
[
  {
    "type": "text",
    "content": "Текст блока",
    "order": 0
  },
  {
    "type": "image", 
    "caption": "Подпись к изображению",
    "order": 1,
    "imageIndex": 0
  }
]
```

**Ответ:**
```json
{
  "success": true,
  "articleId": 123,
  "slug": "test-statyi",
  "mainImageUrl": "https://direct-download-url.com/image.jpg",
  "message": "Статья успешно создана"
}
```

### GET `/api/db/architects`
Получение списка авторов для формы

## Файловая структура на Яндекс.Диске

```
/architecture_bureau_photos/
  articles/
    test-statyi/           # Папка для статьи (по slug)
      main-image-name.jpg  # Главное изображение с префиксом main-
      block0-image1.jpg    # Изображение блока 0
      block1-image2.jpg    # Изображение блока 1
```

## Использование токена Яндекс.Диска

Токен настроен в переменной `YANDEX_TOKEN` в `server.js`:
```javascript
const YANDEX_TOKEN = 'y0__xCiw9GsARjA8zcg_drjmRPYVRdg8smUUH0pJWclVDOPZc2Erg';
```

## Решение проблем

### Проблема 1: Изображения блоков не загружаются
**Причина:** Фронтенд не отправлял файлы изображений блоков  
**Решение:** Обновлен JavaScript для корректной отправки файлов с именами `blockImage_${index}`

### Проблема 2: Ошибка 403 при открытии URL изображений
**Причина:** Неправильный формат прямых ссылок Яндекс.Диска  
**Решение:** Реализована функция `getActualDownloadUrl()` с использованием API Яндекс.Диска

### Проблема 3: Странные имена файлов
**Причина:** Отсутствие обработки специальных символов  
**Решение:** Функция `createSafeFileName()` с транслитерацией и очисткой

## Проверка работоспособности

1. **Запустите сервер:** `node server.js`
2. **Откройте тестовую страницу:** http://localhost:3001/test_image_blocks.html  
3. **Заполните форму:**
   - Введите название статьи
   - Выберите главное изображение
   - Добавьте изображения для блоков
   - Нажмите "Создать статью"
4. **Проверьте результат:**
   - Статья должна создаться с ID
   - Изображения должны загрузиться на Яндекс.Диск
   - URL-ссылки должны работать без ошибок 403
   - В БД должны сохраниться все блоки контента

## Версии

**v1.0** - Базовая функциональность создания статей  
**v2.0** - Исправления загрузки изображений блоков и URL-ссылок  
**v2.1** - Полная интеграция функционала в админ-панель (текущая версия)  
**v2.2** - Упрощение уведомлений и добавление многоуровневой системы получения прямых ссылок 
**v2.3** - Исправления URL главного изображения статьи 
**v2.4** - Исправления отображения через localhost:3001 

## Система получения прямых URL-ссылок

### Многоуровневая система (4 метода)

1. **API загрузки с токеном авторизации**
   - `https://cloud-api.yandex.net/v1/disk/public/resources/download`
   - Основной метод, возвращает временные прямые ссылки
   - Таймаут: 10 секунд

2. **Preview API**
   - `https://downloader.disk.yandex.ru/preview`
   - Альтернативный метод для получения превью изображений
   - Проверяется доступность через HEAD запрос

3. **Публичный API без авторизации**
   - `https://cloud-api.yandex.net/v1/disk/public/resources/download`
   - Дублирование первого метода без токена
   - Для случаев проблем с авторизацией

4. **Fallback на исходную ссылку**
   - Возврат публичной ссылки как последний вариант
   - Используется если все остальные методы не сработали

### Автоматическая проверка валидности

- **HEAD запросы** для проверки доступности URL
- **Статус коды 2xx и 3xx** считаются успешными
- **Таймаут 5 секунд** для каждой проверки
- **Логирование** всех этапов проверки

### Обработка ошибок

- Детальное логирование каждого этапа
- Graceful fallback между методами
- Сохранение в БД только проверенных URL
- Предотвращение зависания через таймауты
- **Унифицированная обработка** для главного изображения и блоков контента

### Типы изображений и их обработка

1. **Главное изображение статьи** (`main_image_url`)
   - Сохраняется в таблице `articles`
   - Префикс имени файла: `main-`
   - Применяется полная 4-уровневая система получения URL

2. **Изображения блоков контента** (`image_url`)
   - Сохраняются в таблице `content_blocks`
   - Префикс имени файла: `block{N}-` где N - номер блока
   - Применяется та же 4-уровневая система получения URL

3. **Логирование процесса**
   - `Главное изображение: ...` - для главного изображения
   - `Блок контента {N}: ...` - для изображений блоков 